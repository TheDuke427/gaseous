#!/usr/bin/with-contenv bashio
# ==============================================================================
# Start Blinko service
# ==============================================================================

declare postgres_password
declare nextauth_secret
declare ingress_url

bashio::log.info "Starting Blinko..."

# Get configuration
postgres_password=$(bashio::config 'postgres_password')
nextauth_secret=$(bashio::config 'nextauth_secret')

# Wait for PostgreSQL to be ready
bashio::log.info "Waiting for PostgreSQL to be ready..."
until psql -U postgres -h localhost -c '\q' 2>/dev/null; do
    sleep 2
done
bashio::log.info "PostgreSQL is ready!"

# Get ingress URL
if bashio::config.true 'ingress'; then
    ingress_url="$(bashio::addon.ingress_url)"
    bashio::log.info "Ingress is enabled. URL: ${ingress_url}"
else
    ingress_url="http://localhost:1111"
    bashio::log.info "Ingress is disabled. Using: ${ingress_url}"
fi

# Set environment variables
export NODE_ENV=production
export NEXTAUTH_URL="${ingress_url}"
export NEXT_PUBLIC_BASE_URL="${ingress_url}"
export NEXTAUTH_SECRET="${nextauth_secret}"
export DATABASE_URL="postgresql://postgres:${postgres_password}@localhost:5432/postgres"

# Pull and run Blinko Docker container
bashio::log.info "Pulling Blinko Docker image..."
docker pull blinkospace/blinko:latest

bashio::log.info "Starting Blinko container..."
exec docker run --rm \
    --name blinko-app \
    --network host \
    -v /data/blinko:/app/.blinko \
    -e NODE_ENV="${NODE_ENV}" \
    -e NEXTAUTH_URL="${NEXTAUTH_URL}" \
    -e NEXT_PUBLIC_BASE_URL="${NEXT_PUBLIC_BASE_URL}" \
    -e NEXTAUTH_SECRET="${NEXTAUTH_SECRET}" \
    -e DATABASE_URL="${DATABASE_URL}" \
    blinkospace/blinko:latest
